bundle:
  name: Team BidIQ Backend
  icon: üêç
  description: Specialized squad for FastAPI backend development and PNCP API integration

agents:
  - architect      # API design and system architecture
  - dev            # FastAPI implementation and coding
  - data-engineer  # Database schema and optimization
  - qa             # Testing and quality assurance

workflows:
  - brownfield-service.yaml

tasks:
  - dev-develop-story.md
  - qa-run-tests.md
  - qa-generate-tests.md
  - db-apply-migration.md
  - db-schema-audit.md

when_to_use:
  - Backend feature development
  - PNCP client enhancements and resilience improvements
  - API endpoint creation and modification
  - Database schema changes and migrations
  - Backend performance optimization

quality_gates:
  pre_commit:
    trigger: Before commit
    agent: qa
    checks:
      - pytest --cov (‚â•70% threshold)
      - mypy . (type checking)
    threshold: Coverage ‚â•70%, no type errors

  pre_merge:
    trigger: Before PR merge
    agent: qa
    checks:
      - pytest --cov --cov-report=html
      - All tests passing
    threshold: Coverage ‚â•70%, 100% tests passing

purpose: |
  Handles all FastAPI backend development for BidIQ uniformes procurement system:

  1. **PNCP API Client** (@architect + @dev):
     - Resilient HTTP client with exponential backoff retry (max 5 retries, 60s max)
     - Rate limiting (10 req/s) and Retry-After header handling
     - Circuit breaker pattern for stability
     - Automatic pagination handling (max 500 items/page)

  2. **Filtering Engine** (@dev):
     - Keyword-based filtering for uniform-related procurement
     - Fail-fast sequential filters: UF ‚Üí Value ‚Üí Keywords ‚Üí Status
     - ~50 keyword terms (uniforme, jaleco, fardamento, etc.)
     - False positive prevention with exclusion keywords
     - Unicode normalization and word boundary regex

  3. **Excel Generation** (@dev):
     - openpyxl-based report generation with styled headers
     - 10 columns: Code, Object, Agency, UF, Municipality, Value, Modality, Dates, Status, Link
     - Auto-width columns, frozen headers, currency formatting
     - Metadata sheet with generation statistics

  4. **LLM Integration** (@dev):
     - GPT-4.1-nano structured output via Pydantic
     - Executive summaries (500 token max, temp=0.3)
     - Fallback mechanism for testing without API key
     - Input limited to 50 bids to avoid token overflow

  5. **Database** (@data-engineer):
     - Bid storage and caching optimization
     - Query performance tuning
     - RLS policies for multi-tenant support (future)

  6. **Testing** (@qa):
     - Unit tests for PNCP client, filter logic, Excel generation, LLM
     - Integration tests with mock PNCP API responses
     - Coverage threshold: 70% minimum

usage_example: |
  # Typical backend development workflow:

  ## 1. Feature Planning (@architect)
  "Design API for pagination in PNCP results"
  ‚Üí Architectural review of impact
  ‚Üí Design decisions documented

  ## 2. Implementation (@dev)
  "*develop"
  ‚Üí Implement pagination logic in pncp_client.py
  ‚Üí Update Excel generation for large result sets
  ‚Üí Code review and self-testing

  ## 3. Testing (@qa)
  "*run-tests"
  ‚Üí Pytest with coverage report
  ‚Üí Integration tests with mock data
  ‚Üí Validates 70% coverage threshold

  ## 4. Merge (@devops)
  ‚Üí PR created with test results
  ‚Üí Auto-merge if all checks pass

activation_instructions: |
  To activate this squad for backend development:

  1. Type: `/squad-creator`
  2. Select: "Load existing squad"
  3. Choose: "team-bidiq-backend"
  4. Start development with: `*develop`

notes:
  - All code uses type hints (Python 3.11+)
  - Pydantic models for all API contracts
  - Circuit breaker prevents cascade failures
  - Rate limiting respects PNCP API constraints
  - Tests use mock PNCP responses for consistency
