workflow:
  id: bidiq-performance-audit
  name: BidIQ Performance Audit
  description: >-
    Agent workflow for performance auditing of BidIQ. Defines baselines, profiles
    current performance, identifies bottlenecks, implements optimizations, and
    validates improvements with regression testing.
  type: brownfield
  project_types:
    - performance
    - optimization
    - profiling
    - audit

  sequence:
    - step: define_baseline_and_targets
      phase: 1
      phase_name: Baseline Definition
      agent: architect
      action: define performance baseline and optimization targets
      creates: docs/performance/baseline-targets.md
      notes: >-
        Definir métricas e targets: tempo de resposta da API (< 2s para busca),
        throughput do PNCP client (requests/s com rate limiting 10 req/s),
        tempo de geração Excel (< 5s para 500 licitações), uso de memória,
        tempo de resposta LLM (< 3s). Documentar baseline atual.

    - step: profile_current_performance
      phase: 2
      phase_name: Performance Profiling
      agent: dev
      action: profile current performance across all components
      creates: docs/performance/profiling-results.md
      notes: >-
        Instrumentar e medir: timing de cada endpoint FastAPI, tempo de
        chamadas PNCP (incluindo retries), tempo de filtragem por volume,
        geração de Excel, chamada LLM. Medir CPU, memória, e network I/O.
        Usar cProfile ou py-spy para Python, lighthouse para frontend.

    - step: analyze_bottlenecks
      phase: 3
      phase_name: Bottleneck Analysis
      agent: architect
      action: analyze bottlenecks and recommend optimizations
      creates: docs/performance/optimization-plan.md
      notes: >-
        Analisar gargalos identificados. Recomendar otimizações: caching de
        resultados PNCP (5min TTL), connection pooling httpx, async/await
        para chamadas paralelas multi-UF, estratégia de paginação otimizada
        (fetch_all generator), streaming Excel para grandes volumes.

    - step: implement_optimizations
      phase: 4
      phase_name: Optimization Implementation
      agent: dev
      action: implement recommended optimizations
      creates: optimized source files
      notes: >-
        Implementar otimizações priorizadas pelo architect. Manter
        compatibilidade com API existente. Adicionar feature flags se
        necessário para rollback. Documentar mudanças no código.
        Seguir padrões existentes (retry logic, rate limiting).

    - step: benchmark_before_after
      phase: 5
      phase_name: Benchmark Comparison
      agent: qa
      action: benchmark before and after optimization
      creates: docs/performance/benchmark-results.md
      notes: >-
        Comparar métricas antes/depois: response times (p50, p95, p99),
        throughput (requests/s), uso de memória, tempo de geração Excel.
        Documentar ganhos percentuais. Verificar que targets definidos
        na fase 1 foram atingidos.

    - step: regression_test
      phase: 6
      phase_name: Regression Testing
      agent: qa
      action: run full regression test suite to ensure no functionality broken
      creates: regression test results
      notes: >-
        Executar pytest --cov completo. Verificar que todos os 82+ testes
        passam. Confirmar coverage >= 70%. Testar edge cases: PNCP API
        timeout, rate limiting 429, LLM fallback, Excel com dados vazios.
        Se regressão detectada, reverter otimização problemática.

  decision_guidance:
    when_to_use:
      - API response times degrading or exceeding targets
      - PNCP client throughput needs improvement
      - Excel generation slow for large datasets
      - Memory usage growing with data volume
      - Pre-release performance validation needed
      - Users reporting slow experience

  handoff_prompts:
    architect_to_dev_profile: "Baseline and targets defined. Profile current performance across all components."
    dev_to_architect_analyze: "Profiling complete with measurements. Analyze bottlenecks and recommend optimizations."
    architect_to_dev_implement: "Optimization plan ready. Implement prioritized optimizations."
    dev_to_qa_benchmark: "Optimizations implemented. Benchmark before/after and run regression tests."
    complete: "Performance audit complete. Optimizations validated with benchmarks and regression tests passing."
    rollback: "Regression detected after optimization. Revert changes and re-analyze approach."
