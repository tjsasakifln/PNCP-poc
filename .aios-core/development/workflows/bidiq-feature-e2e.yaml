workflow:
  id: bidiq-feature-e2e
  name: BidIQ Feature End-to-End
  description: >-
    Workflow completo para implementação de feature full-stack: backend (FastAPI) +
    frontend (Next.js/React) + testes. Desde a criação da story até PR e validação CI.
    Garante cobertura de testes backend >= 70% e frontend >= 60%.
  type: brownfield
  project_types:
    - feature-addition
    - full-stack-feature
    - end-to-end

  sequence:
    - step: story_creation
      phase: 1
      phase_name: "Criação da Story"
      agent: pm
      action: create_story_with_acceptance_criteria
      creates: docs/stories/story-X.X-feature.md
      notes: |
        @pm cria story com critérios de aceite a partir do requisito:

        ESTRUTURA:
        1. Título e descrição clara da feature
        2. Critérios de aceite (Given/When/Then)
        3. Tasks técnicas (backend, frontend, testes)
        4. Definition of Done
        5. Estimativa de esforço

        PADRÃO: docs/stories/ existentes
        - Formato: story-X.X-<nome>.md
        - Checkboxes para tracking de progresso

        OUTPUT: docs/stories/story-X.X-<nome>.md

    - step: api_contract_design
      phase: 2
      phase_name: "Design do Contrato API"
      agent: architect
      action: design_api_contract
      requires: docs/stories/story-X.X-feature.md
      creates: docs/architecture/api-contract-feature.md
      notes: |
        @architect define o contrato da API e componentes afetados:

        RESPONSABILIDADES:
        1. Request/Response schemas (Pydantic models)
        2. Endpoint path, method, status codes
        3. Error responses e edge cases
        4. Componentes frontend afetados
        5. Impacto em módulos existentes (filter.py, excel.py, llm.py)

        REFERÊNCIA: schemas.py (BuscaRequest, ResumoLicitacoes)

        OUTPUT: Contrato API documentado

    - step: backend_implementation
      phase: 3
      phase_name: "Implementação Backend"
      agent: dev
      action: implement_backend_endpoint
      requires: docs/architecture/api-contract-feature.md
      creates:
        - backend/main.py (atualizado)
        - backend/schemas.py (atualizado)
      notes: |
        @dev implementa o endpoint FastAPI:

        COMPONENTES:
        1. Pydantic models (request/response)
        2. FastAPI route com type hints
        3. Business logic (filtros, transformações)
        4. Error handling (HTTPException com status codes)
        5. Integração com módulos existentes

        PADRÕES:
        - Type hints em todas as funções
        - Docstrings Google style
        - Structured logging
        - Pydantic validation (não checks manuais)

        OUTPUT: Endpoint funcional no backend

    - step: frontend_implementation
      phase: 4
      phase_name: "Implementação Frontend"
      agent: dev
      action: implement_frontend_component
      requires:
        - docs/architecture/api-contract-feature.md
        - backend/main.py
      creates:
        - frontend/app/ (componentes atualizados)
      notes: |
        @dev implementa o componente React/Next.js:

        COMPONENTES:
        1. React component com TypeScript
        2. Interface para API response (sem `any`)
        3. Estado com useState hooks
        4. Chamada API via fetch/route handler
        5. Loading states e error handling
        6. Tailwind CSS para styling

        PADRÕES:
        - Interfaces para todos os tipos
        - Strict null checks
        - JSDoc para funções exportadas
        - Next.js App Router (app/)

        OUTPUT: Componente funcional no frontend

    - step: backend_tests
      phase: 5
      phase_name: "Testes Backend"
      agent: qa
      action: create_backend_tests
      requires:
        - backend/main.py
        - backend/schemas.py
      creates: backend/tests/test_feature.py
      notes: |
        @qa cria testes pytest para o backend:

        COBERTURA:
        1. Endpoint happy path (200 OK)
        2. Validação de input (422 Unprocessable Entity)
        3. Error handling (404, 500)
        4. Business logic (filtros, transformações)
        5. Edge cases (dados vazios, limites)

        THRESHOLD: Coverage >= 70%
        COMANDO: pytest --cov --cov-report=html

        OUTPUT: backend/tests/test_<feature>.py

    - step: frontend_tests
      phase: 6
      phase_name: "Testes Frontend"
      agent: qa
      action: create_frontend_tests
      requires: frontend/app/
      creates: frontend/__tests__/feature.test.tsx
      notes: |
        @qa cria testes Jest para o frontend:

        COBERTURA:
        1. Renderização do componente
        2. Interações do usuário (clicks, inputs)
        3. Chamadas API (mock fetch)
        4. Loading states e error states
        5. Edge cases (lista vazia, erro de rede)

        THRESHOLD: Coverage >= 60%
        COMANDO: npm run test:coverage

        OUTPUT: frontend/__tests__/<feature>.test.tsx

    - step: pr_and_ci
      phase: 7
      phase_name: "PR e Validação CI"
      agent: devops
      action: create_pr_validate_ci
      requires:
        - backend/tests/test_feature.py
        - frontend/__tests__/feature.test.tsx
      notes: |
        @devops cria PR e valida CI:

        PASSOS:
        1. git branch feature/<nome>
        2. Commit com conventional commits (feat: ...)
        3. gh pr create com description detalhada
        4. Verificar CI passes (pytest, jest, lint)
        5. Validar coverage thresholds

        CHECKLIST:
        - [ ] Backend tests passing (pytest)
        - [ ] Frontend tests passing (jest)
        - [ ] Backend coverage >= 70%
        - [ ] Frontend coverage >= 60%
        - [ ] Lint passing
        - [ ] PR description com summary e test plan

        OUTPUT: PR criado e CI validado

  decision_guidance:
    when_to_use:
      - Nova feature que requer backend + frontend
      - Endpoint novo com UI correspondente
      - Feature completa end-to-end com testes
      - Adição de funcionalidade ao sistema BidIQ
      - Qualquer mudança que toca ambos backend e frontend

  handoff_prompts:
    story_complete: |
      Story criada: docs/stories/story-X.X-<nome>.md

      Próximo: @architect para design do contrato API (FASE 2)

    design_complete: |
      Contrato API definido. Schemas e endpoints documentados.

      Próximo: @dev para implementação backend (FASE 3)

    backend_complete: |
      Backend implementado: endpoint FastAPI funcional.

      Próximo: @dev para implementação frontend (FASE 4)

    frontend_complete: |
      Frontend implementado: componente React funcional.

      Próximo: @qa para testes backend e frontend (FASES 5-6)

    tests_complete: |
      Testes completos:
      - Backend: pytest coverage >= 70%
      - Frontend: jest coverage >= 60%

      Próximo: @devops para PR e validação CI (FASE 7)

    workflow_complete: |
      Feature E2E completa!
      - Story documentada
      - Backend implementado e testado
      - Frontend implementado e testado
      - PR criado e CI validado
