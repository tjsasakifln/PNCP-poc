name: Sync Sectors Fallback

# Run monthly on the 1st at 3 AM UTC, or manually via workflow_dispatch
on:
  schedule:
    - cron: '0 3 1 * *'  # Monthly on the 1st at 3 AM UTC
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (preview changes without committing)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  sync-sectors:
    name: Sync SETORES_FALLBACK from Backend
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Run sync script (dry run)
        if: github.event.inputs.dry_run == 'true'
        run: node scripts/sync-setores-fallback.js --dry-run
        env:
          BACKEND_URL: ${{ secrets.PRODUCTION_BACKEND_URL || 'https://bidiq-backend-production.up.railway.app' }}

      - name: Run sync script (apply changes)
        if: github.event.inputs.dry_run != 'true'
        run: node scripts/sync-setores-fallback.js
        env:
          BACKEND_URL: ${{ secrets.PRODUCTION_BACKEND_URL || 'https://bidiq-backend-production.up.railway.app' }}

      - name: Check for changes
        id: git-check
        if: github.event.inputs.dry_run != 'true'
        run: |
          git diff --exit-code frontend/app/buscar/hooks/useSearchFilters.ts || echo "changed=true" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.git-check.outputs.changed == 'true' && github.event.inputs.dry_run != 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore(frontend): sync SETORES_FALLBACK from backend'
          title: 'chore: Sync SETORES_FALLBACK with backend sector definitions'
          body: |
            ## Automated Sector Sync

            This PR was automatically created by the monthly sector sync workflow.

            ### Changes
            - Updated `SETORES_FALLBACK` in `frontend/app/buscar/hooks/useSearchFilters.ts`
            - Synced with backend `/setores` endpoint

            ### What to review
            - [ ] New sectors added correctly
            - [ ] Removed sectors are intentional
            - [ ] Sector descriptions are accurate
            - [ ] No unintended changes

            ### Testing
            ```bash
            cd frontend
            npm run dev
            # Navigate to /buscar and verify sector dropdown
            ```

            ---
            ü§ñ Generated by `.github/workflows/sync-sectors.yml`
          branch: chore/sync-sectors-fallback
          delete-branch: true
          labels: |
            automated
            frontend
            chore
          assignees: ${{ github.repository_owner }}
          reviewers: ${{ github.repository_owner }}

      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.git-check.outputs.changed }}" = "true" ]; then
            echo "‚úÖ Sector sync completed - PR created"
          elif [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "‚ÑπÔ∏è Dry run completed - no changes applied"
          else
            echo "‚ÑπÔ∏è No changes needed - sectors already in sync"
          fi
