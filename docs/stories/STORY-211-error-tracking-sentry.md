# STORY-211: Error Tracking — Install & Configure Sentry

**Status:** Pending
**Priority:** P0 — Blocks GTM Launch (Observability GTM Blocker)
**Sprint:** Sprint 1 (Week 1)
**Estimated Effort:** 2 days
**Source:** AUDIT-FRENTE-4-OBSERVABILITY (Risk #1), AUDIT-FRENTE-6-BUSINESS (GAP-06), AUDIT-CONSOLIDATED (Tier 1)
**Squad:** team-bidiq-backend + team-bidiq-frontend (dev, devops)

---

## Context

The observability audit rated Error Tracking as **ABSENT** and flagged it as a **GTM blocker**. Currently:
- Backend Python exceptions go to `logger.error()` → Railway stdout (7-day retention, text grep only)
- Frontend component errors go to `console.error` → browser console (lost when tab closes)
- Frontend JS errors, unhandled promise rejections: **completely invisible** — no `window.onerror`, no error capture
- No `global-error.tsx` for root layout errors
- No error deduplication, grouping, trending, or user context on errors
- `SENTRY_DSN=` exists as empty placeholder in `.env.example`

**Bottom line:** If Google login breaks at 3 AM, the customer discovers it first.

## Problem

Production errors are invisible to the team. No automated detection, no grouping, no alerting. Backend errors exist only in Railway logs (temporary, text-only). Frontend errors are lost forever.

## Acceptance Criteria

### Backend — Sentry SDK

- [ ] AC1: Install `sentry-sdk[fastapi]` in `backend/requirements.txt`
- [ ] AC2: Initialize Sentry in `backend/main.py` BEFORE `app = FastAPI(...)`:
  ```python
  import sentry_sdk
  from sentry_sdk.integrations.fastapi import FastApiIntegration
  from sentry_sdk.integrations.starlette import StarletteIntegration

  sentry_dsn = os.getenv("SENTRY_DSN")
  if sentry_dsn:
      sentry_sdk.init(
          dsn=sentry_dsn,
          integrations=[FastApiIntegration(), StarletteIntegration()],
          traces_sample_rate=0.1,
          environment=os.getenv("ENVIRONMENT", "production"),
          release=app.version,
          before_send=scrub_pii,
      )
  ```
- [ ] AC3: Implement `scrub_pii()` callback that strips email addresses, JWT tokens, and user IDs from error events (leverage existing `log_sanitizer.py` patterns)
- [ ] AC4: Add `SENTRY_DSN` to Railway production environment variables
- [ ] AC5: Verify a test exception appears in Sentry dashboard within 60 seconds

### Frontend — Sentry Next.js SDK

- [ ] AC6: Run `npx @sentry/wizard@latest -i nextjs` to generate config files (`sentry.client.config.ts`, `sentry.server.config.ts`, `sentry.edge.config.ts`, `next.config.js` wrapper)
- [ ] AC7: Add `SENTRY_DSN` and `SENTRY_AUTH_TOKEN` to Railway frontend environment variables
- [ ] AC8: Configure source map upload for production builds
- [ ] AC9: Add `global-error.tsx` to `frontend/app/` for root layout error recovery (catches errors that `error.tsx` can't)
- [ ] AC10: Update existing `error.tsx` to report errors to Sentry: `Sentry.captureException(error)`
- [ ] AC11: Verify frontend JS errors appear in Sentry with readable stack traces (source maps working)

### Alerting Rules

- [ ] AC12: Create Sentry alert rule: "New issue" → email to `tiago.sasaki@gmail.com`
- [ ] AC13: Create Sentry alert rule: "Error rate > 5% in 5 minutes" → email notification
- [ ] AC14: Set up Sentry environment tags: `production`, `development`

### Token Prefix Leak Fix (Opportunistic)

- [ ] AC15: Gate OAuth callback `console.log` statements behind `process.env.NODE_ENV === 'development'` in `frontend/app/auth/callback/page.tsx` (line 125 leaks token prefix in production browser console)

### Testing

- [ ] AC16: Backend tests still pass with Sentry installed (no side effects)
- [ ] AC17: Frontend build succeeds with Sentry wrapper in `next.config.js`
- [ ] AC18: `SENTRY_DSN` unset → graceful no-op (no crash)

## Validation Metric

- Deliberate test exception in backend appears in Sentry within 60 seconds
- Frontend `throw new Error("test")` in a component appears in Sentry with readable stack trace
- Sentry dashboard shows 2 projects: `smartlic-backend`, `smartlic-frontend`

## Risk Mitigated

- P0: Invisible production errors — team discovers issues after customers
- P1: Frontend JS errors lost forever
- P1: No error trending or grouping for recurring issues

## File References

| File | Change |
|------|--------|
| `backend/requirements.txt` | Add `sentry-sdk[fastapi]` |
| `backend/main.py` | Add `sentry_sdk.init()` before app creation |
| `frontend/package.json` | Add `@sentry/nextjs` |
| `frontend/sentry.client.config.ts` | NEW (generated by wizard) |
| `frontend/sentry.server.config.ts` | NEW (generated by wizard) |
| `frontend/app/global-error.tsx` | NEW — root layout error boundary |
| `frontend/app/error.tsx` | Add `Sentry.captureException()` |
| `frontend/app/auth/callback/page.tsx` | Gate console.log behind NODE_ENV |
| `.env.example` | Document `SENTRY_DSN` |
