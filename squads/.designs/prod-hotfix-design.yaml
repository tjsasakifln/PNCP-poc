# Squad Design Blueprint
# Generated by *design-squad
# Source: Production logs analysis
# Created: 2026-02-09T19:30:00.000Z

squad:
  name: prod-hotfix-squad
  description: Squad for diagnosing and fixing critical production issues
  domain: prod-hotfix

analysis:
  entities:
    - AuthSession
    - User
    - DateRangeValidation
    - RateLimit
    - ErrorMessage
    - HTTPException
  workflows:
    - fix-auth-security
    - fix-error-messages
    - validate-session
    - improve-logging
  integrations:
    - Supabase
    - FastAPI
    - Next.js
  stakeholders:
    - User
    - Developer
    - Admin

recommendations:
  agents:
    - id: auth-security-fixer
      role: Fixes Supabase auth security issues (getSession vs getUser)
      commands:
        - audit-auth-calls
        - replace-getsession
        - validate-auth-security
      confidence: 0.95
      user_added: false
      user_modified: false

    - id: error-message-improver
      role: Improves error message clarity and user experience
      commands:
        - audit-error-messages
        - map-backend-to-frontend
        - fix-generic-errors
        - test-error-scenarios
      confidence: 0.92
      user_added: false
      user_modified: false

  tasks:
    - name: audit-auth-calls
      agent: auth-security-fixer
      entrada:
        - codebase_paths
        - search_patterns
      saida:
        - auth_call_locations
        - security_issues_count
        - recommended_fixes
      confidence: 0.95

    - name: replace-getsession
      agent: auth-security-fixer
      entrada:
        - file_paths
        - auth_call_locations
      saida:
        - modified_files
        - security_improvements
        - test_results
      confidence: 0.93

    - name: validate-auth-security
      agent: auth-security-fixer
      entrada:
        - modified_files
      saida:
        - validation_results
        - remaining_issues
      confidence: 0.90

    - name: audit-error-messages
      agent: error-message-improver
      entrada:
        - backend_exceptions
        - frontend_error_handlers
      saida:
        - error_flow_map
        - ux_issues_list
      confidence: 0.92

    - name: map-backend-to-frontend
      agent: error-message-improver
      entrada:
        - backend_error_codes
        - frontend_components
      saida:
        - error_mapping_table
        - missing_handlers
      confidence: 0.88

    - name: fix-generic-errors
      agent: error-message-improver
      entrada:
        - error_mapping_table
        - ux_guidelines
      saida:
        - improved_messages
        - user_facing_text
      confidence: 0.90

    - name: test-error-scenarios
      agent: error-message-improver
      entrada:
        - test_scenarios
        - error_conditions
      saida:
        - test_results
        - screenshots
        - validation_report
      confidence: 0.87

  template: basic
  config_mode: extend

metadata:
  created_at: 2026-02-09T19:30:00.000Z
  source_docs:
    - Production logs (2026-02-09)
    - Supabase security warnings
    - Date range validation errors
  user_adjustments: 0
  overall_confidence: 0.91

# PRODUCTION CONTEXT
production_issues:
  issue_1:
    severity: CRITICAL
    type: security
    description: >
      Multiple instances of insecure getSession() usage instead of getUser().
      Supabase warns this is a security risk as session data from storage
      may not be authentic.
    affected_files:
      - frontend/middleware.ts
      - frontend/app/components/AuthProvider.tsx
      - frontend/app/auth/callback/page.tsx
    fix_priority: P0

  issue_2:
    severity: CRITICAL
    type: ux
    description: >
      Backend date range validation returns technical error message, but
      frontend shows generic "Rate limit exceeded" message instead.
      User sees "Algo deu errado" when the real issue is date range > 7 days.
    backend_location: backend/main.py:964
    frontend_impact: Generic error toast
    user_confusion: HIGH
    fix_priority: P0

# EXPECTED OUTCOMES
success_criteria:
  auth_security:
    - Zero getSession() calls accessing user object
    - All auth checks use getUser()
    - Security warnings eliminated from logs
    - Tests pass with new auth pattern

  error_messages:
    - Date range errors show actual issue to user
    - No more "Rate limit" when it's actually date range
    - Clear, actionable error messages
    - User knows exactly what to fix

# ROLLOUT PLAN
deployment:
  phase_1:
    name: Auth Security Fix
    tasks:
      - audit-auth-calls
      - replace-getsession
      - validate-auth-security
    tests_required: true
    rollback_plan: Git revert

  phase_2:
    name: Error Message Clarity
    tasks:
      - audit-error-messages
      - map-backend-to-frontend
      - fix-generic-errors
      - test-error-scenarios
    tests_required: true
    rollback_plan: Git revert
